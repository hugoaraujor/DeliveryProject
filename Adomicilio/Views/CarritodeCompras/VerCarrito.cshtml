@model IEnumerable<Adomicilio.Models.CarritodeComprasViewModel>
@{
    ViewBag.Title = "Index";
}
@using Adomicilio.Models
@{ string currenturl = HttpContext.Current.Request.Url.PathAndQuery;
    var visible = true;
    var sessionidstr = HttpContext.Current.Session.SessionID;
    var varuserid = ViewBag.userid;
    bool val1 = (System.Web.HttpContext.Current.User != null) && System.Web.HttpContext.Current.User.Identity.IsAuthenticated;
    if (varuserid == null)
    { varuserid = "0"; }


   

}

<div class="row">
    <div id="adphone" name="adphone" class="col-sm-3 col-md-3 ">
        <dl>
            <dd>&nbsp</ dd>
            <dd>&nbsp</ dd>
            <dd> Estamos para Servirle</ dd>
            <dd>(0265) 631-88-88</ dd>
        </dl>
    </div>
    <div class="col-sm-6 col-md-6 ">

        Hello
    </div>
    <div id="toprightad" name="toprightad" class="col-sm-3 col-md-3 ">
        <dl>
            <dd>Su publicidad</ dd>
            <dd>aqui se ve</ dd>
            <dd>Contactanos!</ dd>
            <dd>(0265) 631-88-88</ dd>
        </dl>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <ol class="breadcrumb">
            <li><a href="/">Inicio</a></li>
            <li><a href="#"><b>Carrito de Compra</b></a></li>

        </ol>
    </div>
</div>
@if (@Model.ToList().Count == 0)
{
    <div id="vacio" name="vacio">
        <b class="active"> Su carrito esta vacio.</b><p>El proposito de su carrito de compras es el servicio, Llenelo con deliciosos platos de sus sitios de comidas o bebidas favoritos.Si ya tienes una cuenta, ingrese haciendo Login.continue comprando en la tienda que prefiera y haga click en el boton del Carrito para regresar aqui.
        <p>Los precios y la disponibilidad dependen del sitio que escoja para hacer sus compras y del momento que la ejecute.</p>
    </div>
}
else
{
    <div id="Centro" name="Centro" class="col-sm-9 col-md-9">
        <div class="wrapcarritodecompras ">
            <div class="row ">
                <div class="row headcart">
                    <div class="col-xs-6 col-sm-6 col-md-6">
                        <span>Producto</span>
                    </div>

                    <div class="col-xs-3 col-sm-3  col-md-3 ">
                        <span>Monto</span>
                    </div>
                    <div class="col-xs-2 col-sm-2   col-md-2">
                        <span>Cantidad</span>
                    </div>
                </div>

                <hr />
                <div class="carritoview col-sm-12 col-md-12 col-lg-12" >
                    @foreach (var item in Model)
                    {
                        var i = 0;
                        var tag = "cartcant" + @item.id;
                        var tag2 = "cartcantcopy" + @item.id;
                        var preciovar = "precio" + @item.id;
                       
                    <div class="row">
                        <div class="col-md-2">
                            <img src="@item.imagenstr" id="imagencarrito" name="imagencarrito" />
                        </div>
                        <div class="form-group col-lg-4 col-sm-4 col-sx-4  col-md-4">
                            <div class="row">
                                <span id="cartname" name="cartname">@item.Nombre</span>
                            </div>
                            <div class="row">
                                <span id="razoncart" name="razoncart">@Helpers.Titlecase(@item.RazonSocial)</span>
                            </div>
                            <div class="row">
                                <div class="form-group ">
                                    @Html.DisplayFor(modelItem => item.ingredientes)
                                    @if (item.Extra != null)
                                        { <p><b>Adicional</b>:@Html.DisplayFor(modelItem => item.Extra)</p>

                                        }
                                </div>
                            </div>
                            <div class="row">
                                @Html.DisplayFor(modelItem => item.Mensaje)
                            </div>
                            <div class="row">
                                <a href="#" onclick="Deletecart(@item.id)">Borrar</a>
                            </div>
                        </div>
                        <div class="form-group col-sm-3 col-md-3">
                            <span id="@preciovar" name="@preciovar">@Helpers.Getvalue(@item.Precio)</span>
                        </div>
                        <div class="form-group col-sm-3 col-md-2">

                            <input type="number" class="form-control" id="@tag" name="@tag" minvalue="1" maxvalue="99" value="@item.Cant" onchange="edit(@item.id)" />

                        </div>

                        <input type="hidden" id="@tag2" name="@tag2" minvalue="1" maxvalue="99" value="@item.Cant" />


                    </div>
                    <hr />

                    }



                    <div class="row">
                        <div class="form-group col-md-2">

                        </div>



                        <div class="form-group col-md-3">
                            <div class="row">
                                <span><b class="active">Monto Total</b> </span>
                            </div>

                        </div>
                        <div class="form-group col-md-2">
                            <span id="carritomonto" name="carritomonto">Bs. 0</span>
                        </div>
                    </div>

                </div>
            </div>



        </div>
    </div>
}

<div id="Derecha" name="Derecha" class="col-md-3 col-lg-3 ">
    @if (@Model.ToList().Count > 0)
    {
        <div class="well well-md ">
            <center><span id="carritoarticulos" name="carritoarticulos">0</span></center>
            <center><span id="totalmonto" name="totalmonto">0</span></center>
            <center> 
           <button id="comprar" name="comprar" onclick="comprar(@val1)">Comprar</button></center>

        </div>
     }
</div>
<!-- <VENTANA MODAL PARA HACER LA COMPRA DESDE EL CARRITO- -->

@using (Ajax.BeginForm("Contacto", "Home", null, new AjaxOptions() { HttpMethod = "POST", UpdateTargetId = "formcontact" }))
{

    <div class="modal fade" id="ComprarModal" name="ComprarModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h3 class="modal-title" id="lineModalLabel">Contacto</h3>
                </div>
                <div class="modal-body" id="formcontact">
                  
                </div>

                <div class="modal-footer">
                    <div class="btn-group btn-group-justified" role="group" aria-label="group button">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-default" data-dismiss="modal" role="button">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

}
<!-- <- -->

<script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.js")" type="text/javascript"></script>
<script src="~/Scripts/cart.js"></script>

@Scripts.Render("~/bundles/jquery")
@section Scripts {


    <script>
        updatecart('@sessionidstr', '@varuserid', 'carritoarticulos', 'carritomonto', 'totalmonto');


             function Deletecart(pid)
             {
                 var sesss = '@sessionidstr'; var us = '@varuserid';
                 alert(pid);

                 $.ajax({
                     url: "/CarritodeCompras/Deletecart",
                     data: { id: pid },
                     type: 'POST',
                     success: function (result) {
                         location.reload();
                     },
                 });
             }
             function cleannumeric(currencystr) {
                 var retorno;
                 retorno = currencystr.replace("Bs.", "");
                 retorno = retorno.replace(".", "");
                 retorno = retorno.replace(",", ".");
                 return retorno;
             }

             function edit(pid)
             {   var cant = parseFloat(document.getElementById("cartcant" + pid).value);
                 var cant2 = parseFloat(document.getElementById("cartcantcopy" + pid).value);
                 var dife = 0;
                     if (cant2 > cant)
                        dife = cant2 - cant;
                     if (cant > cant2)
                         dife = cant - cant2;
                     if (cant == cant2)
                         return;
                     if (cant <= 0) {
                         alert("bajo");
                         document.getElementById("cartcant" + pid).value=cant2;
                         return;
                     }
                     var limpio = cleannumeric(document.getElementById("precio" + pid).innerText);
                     var amount = parseFloat(limpio);
                     var pucost = (amount / cant2);
                     var amount2 = (pucost* cant);
                       var currentv = currencyFormatES(amount2);


                 $.ajax({
                     url: "/CarritodeCompras/Editcant",
                     data: { id: pid,n:cant,precio:amount2 },
                     type: 'POST',
                     success: function (result) {
                         document.getElementById("precio" + pid).innerText = "Bs." + currentv;
                         document.getElementById("cartcantcopy" + pid).value = cant;
                         console.log(result);
                         console.log("sucess");
                         updatecart('@sessionidstr', '@varuserid', 'carritoarticulos', 'carritomonto', 'totalmonto');
                     }
                 });


             }

           function comprar(logeado)
         {
               if (!logeado) {
                   localStorage.setItem('laterurl', '@currenturl');
                   window.location.href = "/Account/Login?returnurl=@currenturl";
               }
               else
               {
                      window.location.href = "/Direcciones/Manage?id=@varuserid";
               }

        }

    </script>

}
